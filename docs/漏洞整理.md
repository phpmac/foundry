# nodes-nft 项目安全审计报告

本报告涵盖了对 `/Users/a/Downloads/nodes-nft` 目录下智能合约（Diamond Pattern）、后端（NestJS）及前端（Next.js）代码的安全分析。

## 1. 智能合约安全审计 (EIP-2535 Diamond)

项目结构采用了 Diamond 模式，核心逻辑分布在不同的 Facet 中。

### 🔴 高风险 (High Risk)
*   **MarketplaceFacet: `buyNFT` 状态更新顺序**
    *   **描述**：在旧版实现中，转账逻辑发生在状态更新之前，存在重入攻击风险。
    *   **状态**：已在 `MarketplaceFacet.sol:105-118` 中通过 Checks-Effects-Interactions 模式修复。
*   **NFTManager: `_calculateTotalPendingClaims` Gas 耗尽**
    *   **描述**：循环遍历所有 NFT 计算奖励，当 NFT 数量巨大时会导致 Gas 限制。
    *   **修复**：代码中已添加 `totalMinted <= 2000` 的限制或建议分批处理。

### 🟡 中风险 (Medium Risk)
*   **中心化权限风险**：`onlyMaster` 权限过大，可直接修改 `marketFeeRate` 和 `treasury`，建议引入多签钱包（Multisig）管理。
*   **RewardFacet Oracle 依赖**：奖励分发高度依赖 Oracle 地址，若 Oracle 私钥泄露或恶意喂价，会直接影响奖励分配的公平性。

---

## 2. 后端安全审计 (NestJS)

### 🔴 高风险 (High Risk)
*   **管理员私钥明文引用 (`contract.service.ts`)**
    *   **漏洞**：`ADMIN_PRIVATE_KEY` 直接从环境变量中读取并常驻内存。
    *   **危害**：服务器一旦被渗透（如通过 RCE 漏洞），攻击者可获取私钥并完全控制合约。
    *   **建议**：使用 KMS（Key Management Service）或隔离的签名服务器。

### 🟡 中风险 (Medium Risk)
*   **用户/管理员枚举漏洞 (`auth.service.ts`)**
    *   **漏洞**：`checkTotpStatus` 允许公开查询任何用户是否启用了 TOTP，且登录接口在未提供 OTP 时对存在/不存在的用户返回码不同（400 vs 401）。
    *   **危害**：攻击者可以枚举有效的管理员用户名。
*   **TOTP 秘钥明文存储**：数据库中的 `totpSecret` 建议加密存储，防止数据库泄露导致二步验证失效。

---

## 3. 前端安全审计 (Next.js)

### 🟡 中风险 (Medium Risk)
*   **localStorage 存储敏感信息 (`client.ts`)**
    *   **漏洞**：JWT Token (`admin_token`) 存储在 `localStorage` 中。
    *   **危害**：极易受到 XSS（跨站脚本攻击）的影响，攻击者可通过脚本窃取 Token。
    *   **建议**：使用 `HttpOnly` 且带有 `Secure` 标志的 Web Cookie。

### 🟢 低风险 (Low Risk)
*   **客户端权限控制不足 (`layout.tsx`)**：路由拦截仅在客户端渲染时检查，虽不影响接口安全，但会泄露后台 UI 结构及逻辑细节。

---

## 4. 总结与建议

| 模块 | 安全等级 | 状态总结 |
| :--- | :--- | :--- |
| **智能合约** | 🟢 良好 | 关键漏洞已修复，架构设计符合 Diamond 规范。 |
| **系统后端** | 🟡 警告 | 私钥管理和认证逻辑存在单点故障及信息泄露风险。 |
| **项目前端** | 🟡 警告 | 存储方案需加强安全性，建议防范 XSS 攻击。 |

**审计员签字**：Claude Code
**日期**：2026-01-09
