# MC Token 卖出无税漏洞分析

## 问题描述

交易 `0x0055ecb4d2c44ae0cc9e8c3b25bda175548d39b880807ae8c6da43694d67445f` 卖出100 MC，但没有收取10%税收。

## 根本原因

**交易对未在MC合约中注册为 `isPair`**

### 交易详情

| 项目 | 值 |
|------|-----|
| 发送者 | 0xD3281aEcdB804B8687B1d83081c8801e2c5EcE6f |
| 交易对 | 0x4cD8330EE5F2f37F7A135883e420105d7A8969f8 (PancakeSwap V2: MC/USDT) |
| 卖出数量 | 100 MC |
| 收到数量 | 0.021317279489137097 USDT |
| 是否在白名单 | 否 |
| `isPair` 状态 | **false** (未注册) |

## 漏洞原理

### MC.sol 税收逻辑 (第334-344行)

```solidity
// 只对卖出操作收税 (从交易对转出)
// 排除: 发送者是合约本身、白名单、owner、税收分发合约
if (
    isPair[to] &&                    // ← 关键条件：必须 isPair[to] == true
    !isWhitelisted[from] &&
    from != owner() &&
    from != address(this) &&
    from != taxDistributor
) {
    actualAmount = _applySellTax(from, to, amount);
}
```

### 漏洞触发条件

税收只在 `isPair[to] == true` 时触发。如果交易对未注册：

1. `isPair[0x4cD8330...]` 返回 `false`
2. 税收条件不满足
3. `_applySellTax()` 不会被调用
4. 用户获得全额代币，无10%滑点

## 验证

```bash
# 查询交易对注册状态
cast call 0xcD0c229a02a9fBCbb6a19347a48d004c46d7e4d1 \
  "isPair(address)(bool)" \
  0x4cD8330EE5F2f37F7A135883e420105d7A8969f8 \
  --rpc-url https://bsc-dataseed1.binance.org

# 返回: false (未注册)
```

### 正确的创建交易对流程 (MC.sol:184-202)

```solidity
function createPair(address _router) external onlyOwner returns (address pair) {
    pancakeRouter = _router;
    pair = IPancakeFactory(IPancakeRouter(_router).factory()).createPair(
        address(this), USDT
    );
    isPair[pair] = true;  // ← 必须设置！
    emit PairUpdated(pair, true);
}
```

## 修复方案

### 方案1: 注册交易对

```solidity
// 由 owner 调用
mc.setPair(0x4cD8330EE5F2f37F7A135883e420105d7A8969f8, true);
```

### 方案2: 自动检测交易对

```solidity
function _update(address from, address to, uint256 amount) internal override {
    // ...

    // 自动检测是否为交易对 (通过检查代码)
    bool isActualPair = to.code.length > 0 &&
                       IPancakeFactory(factory).getPair(address(this), USDT) == to;

    if (isActualPair && !isWhitelisted[from] && ...) {
        actualAmount = _applySellTax(from, to, amount);
    }
}
```

### 方案3: 基于Factory查询

```solidity
function _isPair(address addr) internal view returns (bool) {
    address factory = IPancakeRouter(pancakeRouter).factory();
    address expectedPair = IPancakeFactory(factory).getPair(address(this), USDT);
    return addr == expectedPair;
}
```

## 影响评估

| 影响 | 描述 |
|------|------|
| 税收流失 | 所有通过未注册交易对的卖出都无税收 |
| 任何人可利用 | 只需通过未注册的交易对交易 |
| 潜在损失 | 取决于交易量 |

## 时间线

- 合约部署: 交易对应该在部署后通过 `createPair()` 创建并注册
- 当前状态: 交易对存在于Factory但未在MC合约中注册为 `isPair`

## 相关文件

- 合约: `src/mc/MC.sol`
- 测试: `test/mc/MCMainnetTest.t.sol`
- 交易: `0x0055ecb4d2c44ae0cc9e8c3b25bda175548d39b880807ae8c6da43694d67445f`
