# MC Token 部署指南

## 概述

MC Token 是一个基于 BSC 主网的 ERC20 代币, 具有以下特性:
- 总量: 1.2 亿 MC
- 买入税: 0%
- 卖出税: 10% (2% 钱包1 + 3% 黑洞 + 3% 钱包2 + 2% 钱包3)
- 税收钱包收到 USDT (通过 TaxDistributor 合约自动兑换)
- 黑洞销毁停止阈值: 1200 万 MC

## 合约架构

1. **MC.sol** - 主代币合约
   - 处理转账逻辑和税收
   - 管理白名单和交易开关
   - 管理销毁阈值

2. **TaxDistributor.sol** - 税收分发合约
   - 接收税收 MC
   - 自动 swap 成 USDT
   - 按比例分发到三个钱包

## 部署步骤

### 1. 环境准备

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件, 填入你的私钥和钱包地址
nano .env
```

### 2. 编译合约

```bash
forge build
```

### 3. 部署到 BSC 主网

```bash
forge script script/mc/Deploy.s.sol:DeployScript \
  --rpc-url https://bsc-dataseed.binance.org \
  --broadcast \
  --verify \
  --etherscan-api-key $ETHERSCAN_API_KEY
```

### 4. 部署到测试网 (可选)

```bash
forge script script/mc/Deploy.s.sol:DeployScript \
  --rpc-url https://data-seed-prebsc-1-s1.binance.org:8545 \
  --broadcast
```

## 部署后配置

### 1. 创建交易对

部署后需要创建 MC/USDT 交易对并添加流动性:

```solidity
// 使用 MC 合约的 createPair 函数 (只需要传入 Router 地址)
address pair = mc.createPair(
    0x10ED43C718714eb63d5aA57B78B54704E256024E  // PancakeSwap Router
);
// USDT 和 MC (address(this)) 由合约内部自动处理
```

### 2. 添加流动性

通过 PancakeSwap 网页添加 MC/USDT 流动性.

### 3. 开启交易

```solidity
mc.setTradingEnabled(true);
```

### 4. 设置白名单 (可选)

```solidity
// 设置不需要税收的地址 (如团队钱包、流动性池等)
mc.setWhitelist(0x..., true);

// 批量设置
address[] memory addresses = new address[](3);
addresses[0] = 0x...;
addresses[1] = 0x...;
addresses[2] = 0x...;
mc.setWhitelistBatch(addresses, true);
```

## 合约验证

### 方法一: 使用 Foundry 自动验证

在部署时添加 `--verify` 参数:

```bash
# 设置 BscScan API Key
export BLOCKSCOUT_API_KEY=your_blockscout_api_key
# 或使用 BscScan API Key
exportETHERSCAN_API_KEY=your_bscscan_api_key

# 部署并验证
forge script script/mc/Deploy.s.sol:DeployScript \
  --rpc-url https://bsc-dataseed.binance.org \
  --broadcast \
  --verify \
  --etherscan-api-key $ETHERSCAN_API_KEY
```

### 方法二: 手动验证

#### MC 合约验证

```bash
# 验证 MC 合约
forge verify-contract <MC合约地址> \
  src/mc/MC.sol:MC \
  --constructor-args $(cast abi-encode "constructor(address,address,address)" "0x<TAX_WALLET_1> 0x<TAX_WALLET_2> 0x<TAX_WALLET_3>") \
  --chain-id 56 \
  --watch \
  --etherscan-api-key $ETHERSCAN_API_KEY
```

或使用 blockscout:

```bash
forge verify-contract <MC合约地址> \
  src/mc/MC.sol:MC \
  --constructor-args $(cast abi-encode "constructor(address,address,address)" "0x<TAX_WALLET_1> 0x<TAX_WALLET_2> 0x<TAX_WALLET_3>") \
  --verifier blockscout \
  --block-explorer "https://bscscan.com" \
  --watch \
  --etherscan-api-key $BLOCKSCOUT_API_KEY
```

#### TaxDistributor 合约验证

```bash
# 验证 TaxDistributor 合约
forge verify-contract <TAX_DISTRIBUTOR合约地址> \
  src/mc/TaxDistributor.sol:TaxDistributor \
  --constructor-args $(cast abi-encode "constructor(address,address,address,address,address)" "<MC合约地址> 0x10ED43C718714eb63d5aA57B78B54704E256024E 0x<TAX_WALLET_1> 0x<TAX_WALLET_2> 0x<TAX_WALLET_3>") \
  --chain-id 56 \
  --watch \
  --etherscan-api-key $ETHERSCAN_API_KEY
```

### 方法三: BscScan 网页验证

#### MC 合约

1. 访问 https://bscscan.com/address/<MC合约地址>#code
2. 点击 "Verify and Publish"
3. 填写以下信息:
   - **Compiler Type**: Solidity (Single file)
   - **Compiler Version**: 0.8.20
   - **Open Source License Type**: MIT
   - **Optimization**: Yes (200 runs)
   - **合约代码**: 粘贴 `src/mc/MC.sol` 的内容
   - **Constructor Arguments**:
     ```
     000000000000000000000000<TAX_WALLET_1去掉0x前缀, 64位>
     000000000000000000000000<TAX_WALLET_2去掉0x前缀, 64位>
     000000000000000000000000<TAX_WALLET_3去掉0x前缀, 64位>
     ```

#### TaxDistributor 合约

1. 访问 https://bscscan.com/address/<TAX_DISTRIBUTOR合约地址>#code
2. 点击 "Verify and Publish"
3. 填写以下信息:
   - **Compiler Type**: Solidity (Single file)
   - **Compiler Version**: 0.8.20
   - **Open Source License Type**: MIT
   - **Optimization**: Yes (200 runs)
   - **合约代码**: 粘贴 `src/mc/TaxDistributor.sol` 的内容
   - **Constructor Arguments**:
     ```
     000000000000000000000000<MC合约地址去掉0x前缀, 64位>
     0000000000000000000000010ED43C718714eb63d5aA57B78B54704E256024E
     000000000000000000000<TAX_WALLET_1去掉0x前缀, 64位>
     000000000000000000000<TAX_WALLET_2去掉0x前缀, 64位>
     000000000000000000000<TAX_WALLET_3去掉0x前缀, 64位>
     ```

### 验证检查清单

- [ ] MC 合约验证通过
- [ ] TaxDistributor 合约验证通过
- [ ] 合约代码可读
- [ ] 构造函数参数正确显示

## 安全检查清单

- [ ] 确认税收钱包地址正确
- [ ] 确认 Owner 是预期的地址
- [ ] 确认 TaxDistributor 正确绑定
- [ ] 测试小额交易
- [ ] 测试税收分发
- [ ] 验证合约在 BscScan
- [ ] 放弃所有权 (如果需要): `mc.renounceOwnership()`

## 注意事项

1. **私钥安全**: 不要将私钥提交到 git
2. **税收钱包**: 部署前确认税收钱包地址正确
3. **交易开关**: 默认关闭, 需要手动开启
4. **TaxDistributor**: MC 和 TaxDistributor 需要分开部署以便验证

## 故障排查

### 交易失败
- 检查交易开关是否开启
- 检查地址是否在白名单中
- 检查是否有足够的 BNB 作为 gas

### 税收未分发
- 检查 TaxDistributor 是否正确绑定
- 检查是否有 MC 余额在 TaxDistributor 中
- 手动调用 `distributor.distributeTax()`

## 合约交互

### 查看税收分发状态
```solidity
// 查看 TaxDistributor 持有的 MC 数量
distributor.getMCBalance();

// 查看当前是否达到销毁阈值
mc.hasReachedBurnThreshold();
```

### 手动触发税收分发
```solidity
// 任何人都可以调用
distributor.distributeTax();
```

### 更新配置
```solidity
// 更新税收钱包
mc.updateTaxWallets(newWallet1, newWallet2, newWallet3);

// 更新 TaxDistributor 的税收钱包
distributor.setTaxWallets(newWallet1, newWallet2, newWallet3);

// 更新 Router
distributor.setRouter(newRouter);

// 切换税收分发模式
mc.setDistributeTaxEnabled(false); // 直接发 MC 给钱包
mc.setDistributeTaxEnabled(true);  // 通过 TaxDistributor 换成 USDT
```

## Gas 估算

- 部署 MC: 约 2,500,000 gas
- 部署 TaxDistributor: 约 800,000 gas
- 总计: 约 3,300,000 gas
- 费用 (假设 20 gwei): 约 0.066 BNB
